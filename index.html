<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ø¥Ø¯Ø§Ø±Ø© Ù…Ø¹Ù‡Ø¯ Ø´Ù†Ù‚ÙŠØ·</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{font-family:Tahama,Arial;background:#f4f6f8;margin:0}
header{background:#2196f3;color:#fff;padding:10px;text-align:center}
header img{width:60px;border-radius:50%}
.container{padding:10px}
button{background:#2196f3;color:#fff;border:none;padding:6px 10px;border-radius:5px;margin:2px}
input{width:100%;padding:6px;margin-bottom:6px}
.card{background:#fff;padding:8px;margin-bottom:6px;border-radius:6px;display:flex;justify-content:space-between;align-items:center}
.hidden{display:none}
.counter{font-weight:bold;margin:8px 0}
.photo{width:120px;border-radius:6px}
.modal{position:fixed;top:0;right:0;left:0;bottom:0;background:#0008;display:flex;align-items:center;justify-content:center}
.modal>div{background:#fff;padding:10px;border-radius:8px;width:90%;max-width:400px}
</style>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

<script>
var firebaseConfig={
 apiKey:"AIzaSyBljZoIG9rTcz-kTX9o9CL8l3WvciZjyTY",
 authDomain:"chinguitt2718.firebaseapp.com",
 databaseURL:"https://chinguitt2718-default-rtdb.firebaseio.com",
 projectId:"chinguitt2718",
 storageBucket:"chinguitt2718.firebasestorage.app"
};
firebase.initializeApp(firebaseConfig);
var db=firebase.database();
var storage=firebase.storage();
</script>

</head>
<body>

<header>
<img src="logo.png">
<div>Ø¥Ø¯Ø§Ø±Ø© Ù…Ø¹Ù‡Ø¯ Ø´Ù†Ù‚ÙŠØ·</div>
</header>

<div class="container">

<button onclick="toggleForm()">â• Ø¥Ø¶Ø§ÙØ© Ø£Ø³ØªØ§Ø°</button>
<button onclick="render()">ğŸ“‹ Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©</button>

<input placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ·Ù†ÙŠ" oninput="search(this.value)">

<div class="counter" id="count"></div>

<div id="form" class="hidden">
<input id="name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø£Ø³ØªØ§Ø°">
<input id="birth" placeholder="ØªØ§Ø±ÙŠØ® ÙˆÙ…Ø­Ù„ Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯">
<input id="nid" placeholder="Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ·Ù†ÙŠ">
<input id="join" placeholder="ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù„ØªØ­Ø§Ù‚">
<input id="branch" placeholder="Ø§Ù„ÙØ±Ø¹">
<input id="skill" placeholder="Ø§Ù„ÙƒÙØ§Ø¡Ø©">
<input type="file" id="photo">
<button onclick="save()">ğŸ’¾ Ø­ÙØ¸</button>
</div>

<div id="list"></div>
</div>

<!-- PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
let editId=null;

function getLocal(){return JSON.parse(localStorage.getItem("teachers")||"[]")}
function setLocal(d){localStorage.setItem("teachers",JSON.stringify(d))}

function toggleForm(){
 document.getElementById("form").classList.toggle("hidden");
}

function clearForm(){
 ["name","birth","nid","join","branch","skill","photo"].forEach(i=>{
  let el=document.getElementById(i);
  if(el.type==="file")el.value="";
  else el.value="";
 });
 editId=null;
}

function save(){
 let t={
  name:name.value.trim(),
  birth:birth.value.trim(),
  nid:nid.value.trim(),
  join:join.value.trim(),
  branch:branch.value.trim(),
  skill:skill.value.trim(),
  photo:""
 };

 if(!t.name || !t.nid){
  alert("Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ·Ù†ÙŠ Ø¥Ø¬Ø¨Ø§Ø±ÙŠ");
  return;
 }

 // 1ï¸âƒ£ Ø­ÙØ¸ Ù…Ø­Ù„ÙŠ ÙÙˆØ±ÙŠ
 let data=getLocal();
 let i=data.findIndex(x=>x.nid===t.nid);
 if(i>=0) data[i]=t;
 else data.push(t);
 setLocal(data);

 // 2ï¸âƒ£ ØªÙØ±ÙŠØº Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ + ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù„Ø§Ø¦Ø­Ø©
 clearForm();
 render();

 // 3ï¸âƒ£ Ù…Ø²Ø§Ù…Ù†Ø© Firebase ÙÙ‚Ø· Ø¹Ù†Ø¯ ÙˆØ¬ÙˆØ¯ Ø¥Ù†ØªØ±Ù†Øª
 if(!isOnline()) return;

 let file=photo.files[0];

 if(file){
  let ref=storage.ref("teachers/"+t.nid+".jpg");
  ref.put(file).then(()=>{
    ref.getDownloadURL().then(url=>{
      t.photo=url;
      db.ref("teachers/"+t.nid).set(t);
    });
  }).catch(()=>{});
 }else{
  db.ref("teachers/"+t.nid).set(t);
 }
}

 if(!t.name||!t.nid){alert("Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ·Ù†ÙŠ Ø¥Ø¬Ø¨Ø§Ø±ÙŠ");return}

 let data=getLocal();

 let finish=(obj)=>{
  let i=data.findIndex(x=>x.nid===obj.nid);
  if(i>=0)data[i]=obj; else data.push(obj);
  setLocal(data);
  db.ref("teachers/"+obj.nid).set(obj);
  clearForm();
  render();
 };

 let file=photo.files[0];
 if(file){
  let ref=storage.ref("teachers/"+t.nid+".jpg");
  ref.put(file).then(()=>ref.getDownloadURL().then(u=>{t.photo=u;finish(t)}));
 }else finish(t);
}

function render(arr){
 let data=arr||getLocal();
 list.innerHTML="";
 count.innerText="Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©: "+data.length;
 data.forEach((t,i)=>{
  list.innerHTML+=`
  <div class="card">
   <div>${i+1}. ${t.name}</div>
   <div>
    <button onclick="view('${t.nid}')">Ø¹Ø±Ø¶</button>
    <button onclick="edit('${t.nid}')">ØªØ¹Ø¯ÙŠÙ„</button>
    <button onclick="del('${t.nid}')">Ø­Ø°Ù</button>
   </div>
  </div>`;
 });
}

function view(id){
 let t=getLocal().find(x=>x.nid===id);
 let m=document.createElement("div");
 m.className="modal";
 m.innerHTML=`
 <div id="pdf">
 <h3>${t.name}</h3>
 <p>Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯: ${t.birth}</p>
 <p>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ·Ù†ÙŠ: ${t.nid}</p>
 <p>Ø§Ù„Ø§Ù„ØªØ­Ø§Ù‚: ${t.join}</p>
 <p>Ø§Ù„ÙØ±Ø¹: ${t.branch}</p>
 <p>Ø§Ù„ÙƒÙØ§Ø¡Ø©: ${t.skill}</p>
 ${t.photo?`<img class="photo" src="${t.photo}">`:""}
 <br><br>
 <button onclick="exportPDF()">ğŸ“„ PDF</button>
 <button onclick="this.closest('.modal').remove()">âŒ Ø¥ØºÙ„Ø§Ù‚</button>
 </div>`;
 document.body.appendChild(m);
}

function exportPDF(){
 html2canvas(document.getElementById("pdf")).then(c=>{
  let pdf=new jspdf.jsPDF("p","mm","a4");
  pdf.addImage(c.toDataURL(),"PNG",10,10,190,0);
  pdf.save("Ø§Ø³ØªØ§Ø°.pdf");
 });
}

function edit(id){
 let t=getLocal().find(x=>x.nid===id);
 editId=id;
 name.value=t.name;
 birth.value=t.birth;
 nid.value=t.nid;
 join.value=t.join;
 branch.value=t.branch;
 skill.value=t.skill;
 document.getElementById("form").classList.remove("hidden");
}

function del(id){
 if(!confirm("Ø­Ø°ÙØŸ"))return;
 let d=getLocal().filter(x=>x.nid!==id);
 setLocal(d);
 db.ref("teachers/"+id).remove();
 render();
}

function search(v){
 let d=getLocal().filter(x=>x.name.includes(v)||x.nid.includes(v));
 render(d);
}

render();
</script>

</body>
</html>
